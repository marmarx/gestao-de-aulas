const iconWhatsapp = `
  <svg xmlns="http://www.w3.org/2000/svg" fill="#fff" width="100%" height="100%" viewBox="0 0 16 16">
    <path d="M11.42 9.49c-.19-.09-1.1-.54-1.27-.61s-.29-.09-.42.1-.48.6-.59.73-.21.14-.4 0a5.13 5.13 0 0 1-1.49-.92 5.25 5.25 0 0 1-1-1.29c-.11-.18 0-.28.08-.38s.18-.21.28-.32a1.39 1.39 0 0 0 .18-.31.38.38 0 0 0 0-.33c0-.09-.42-1-.58-1.37s-.3-.32-.41-.32h-.4a.72.72 0 0 0-.5.23 2.1 2.1 0 0 0-.65 1.55A3.59 3.59 0 0 0 5 8.2 8.32 8.32 0 0 0 8.19 11c.44.19.78.3 1.05.39a2.53 2.53 0 0 0 1.17.07 1.93 1.93 0 0 0 1.26-.88 1.67 1.67 0 0 0 .11-.88c-.05-.07-.17-.12-.36-.21z"/><path d="M13.29 2.68A7.36 7.36 0 0 0 8 .5a7.44 7.44 0 0 0-6.41 11.15l-1 3.85 3.94-1a7.4 7.4 0 0 0 3.55.9H8a7.44 7.44 0 0 0 5.29-12.72zM8 14.12a6.12 6.12 0 0 1-3.15-.87l-.22-.13-2.34.61.62-2.28-.14-.23a6.18 6.18 0 0 1 9.6-7.65 6.12 6.12 0 0 1 1.81 4.37A6.19 6.19 0 0 1 8 14.12z"/>
  </svg>
`

const iconReport = `
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewBox="0 0 512 512" version="1.1">
    <g id="add" fill="#fff" transform="translate(42.666667, 85.333333)">
      <path d="M341.333333,1.42108547e-14 L426.666667,85.3333333 L426.666667,341.333333 L3.55271368e-14,341.333333 L3.55271368e-14,1.42108547e-14 L341.333333,1.42108547e-14 Z M330.666667,42.6666667 L42.6666667,42.6666667 L42.6666667,298.666667 L384,298.666667 L384,96 L330.666667,42.6666667 Z M106.666667,85.3333333 L106.666,234.666 L341.333333,234.666667 L341.333333,256 L85.3333333,256 L85.3333333,85.3333333 L106.666667,85.3333333 Z M170.666667,149.333333 L170.666667,213.333333 L128,213.333333 L128,149.333333 L170.666667,149.333333 Z M234.666667,106.666667 L234.666667,213.333333 L192,213.333333 L192,106.666667 L234.666667,106.666667 Z M298.666667,170.666667 L298.666667,213.333333 L256,213.333333 L256,170.666667 L298.666667,170.666667 Z" id="Combined-Shape"></path>
    </g>
  </svg>
`

const iconDetails = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="1.5"/>
    <path d="M12 17V11" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
    <circle cx="1" cy="1" r="1" transform="matrix(1 0 0 -1 11 9)" fill="#fff"/>
  </svg>
`

const iconPlay = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none">
    <path d="M21.4086 9.35258C23.5305 10.5065 23.5305 13.4935 21.4086 14.6474L8.59662 21.6145C6.53435 22.736 4 21.2763 4 18.9671L4 5.0329C4 2.72368 6.53435 1.26402 8.59661 2.38548L21.4086 9.35258Z" fill="#fff"/>
  </svg>
`

const iconPause = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none">
    <path d="M2 6C2 4.11438 2 3.17157 2.58579 2.58579C3.17157 2 4.11438 2 6 2C7.88562 2 8.82843 2 9.41421 2.58579C10 3.17157 10 4.11438 10 6V18C10 19.8856 10 20.8284 9.41421 21.4142C8.82843 22 7.88562 22 6 22C4.11438 22 3.17157 22 2.58579 21.4142C2 20.8284 2 19.8856 2 18V6Z" fill="#fff"/>
    <path d="M14 6C14 4.11438 14 3.17157 14.5858 2.58579C15.1716 2 16.1144 2 18 2C19.8856 2 20.8284 2 21.4142 2.58579C22 3.17157 22 4.11438 22 6V18C22 19.8856 22 20.8284 21.4142 21.4142C20.8284 22 19.8856 22 18 22C16.1144 22 15.1716 22 14.5858 21.4142C14 20.8284 14 19.8856 14 18V6Z" fill="#fff"/>
  </svg>
`

const iconDelete = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none">
    <path d="M4 7H20" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M6 10L7.70141 19.3578C7.87432 20.3088 8.70258 21 9.66915 21H14.3308C15.2974 21 16.1257 20.3087 16.2986 19.3578L18 10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
`

const iconEdit = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24">
    <path d="M20,16v4a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V6A2,2,0,0,1,4,4H8" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
    <polygon fill="none" points="12.5 15.8 22 6.2 17.8 2 8.3 11.5 8 16 12.5 15.8" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
  </svg>
`

const config = `
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7848 0.449982C13.8239 0.449982 14.7167 1.16546 14.9122 2.15495L14.9991 2.59495C15.3408 4.32442 17.1859 5.35722 18.9016 4.7794L19.3383 4.63233C20.3199 4.30175 21.4054 4.69358 21.9249 5.56605L22.7097 6.88386C23.2293 7.75636 23.0365 8.86366 22.2504 9.52253L21.9008 9.81555C20.5267 10.9672 20.5267 13.0328 21.9008 14.1844L22.2504 14.4774C23.0365 15.1363 23.2293 16.2436 22.7097 17.1161L21.925 18.4339C21.4054 19.3064 20.3199 19.6982 19.3382 19.3676L18.9017 19.2205C17.1859 18.6426 15.3408 19.6754 14.9991 21.405L14.9122 21.845C14.7167 22.8345 13.8239 23.55 12.7848 23.55H11.2152C10.1761 23.55 9.28331 22.8345 9.08781 21.8451L9.00082 21.4048C8.65909 19.6754 6.81395 18.6426 5.09822 19.2205L4.66179 19.3675C3.68016 19.6982 2.59465 19.3063 2.07505 18.4338L1.2903 17.1161C0.770719 16.2436 0.963446 15.1363 1.74956 14.4774L2.09922 14.1844C3.47324 13.0327 3.47324 10.9672 2.09922 9.8156L1.74956 9.52254C0.963446 8.86366 0.77072 7.75638 1.2903 6.8839L2.07508 5.56608C2.59466 4.69359 3.68014 4.30176 4.66176 4.63236L5.09831 4.77939C6.81401 5.35722 8.65909 4.32449 9.00082 2.59506L9.0878 2.15487C9.28331 1.16542 10.176 0.449982 11.2152 0.449982H12.7848ZM12 15.3C13.8225 15.3 15.3 13.8225 15.3 12C15.3 10.1774 13.8225 8.69998 12 8.69998C10.1774 8.69998 8.69997 10.1774 8.69997 12C8.69997 13.8225 10.1774 15.3 12 15.3Z" fill="#fff"/>
  </svg>
`

document.getElementById('config-button').innerHTML = config;

// -- Main Functions --

function showPage(id, alunoId = null, lessonDate = null, horario = null) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  dateInputs = document.getElementById(id).querySelector('input[type="date"]')
  if (id === 'agenda') renderAgenda();
  if (id === 'panorama') renderPanorama();
  if (id === 'list-lessons') renderLessons();
  if (id === 'list-students') renderStudents();
  if (id === 'add-lesson') fillDropdown('lesson-form', alunoId, lessonDate, horario);
  if (id === 'add-payment') fillDropdown('payment-form', alunoId);
  if (id === 'edit-event') fillDropdown('edit-event', alunoId, lessonDate, horario)
}

function fillDropdown(page, id = null, date = null, horario = null) {
  const form = document.getElementById(page);
  const sel = form.querySelector('select[name="aluno"]');

  const options = alunos
    .filter(a => !a.pausado)
    .map(a => `<option value="${a.id}">${a.nome}</option>`)
    .join('');
  sel.innerHTML = `<option value="" disabled>Todos os alunos</option>` + options;
  if (id) sel.value = id  // Se um alunoId foi passado, selecione-o
  if (page=='edit-event') {
    form.querySelector('input[name="id"]').value = id
    form.querySelector('input[name="horarioOriginal"]').value = horario
  }
  if (page=='lesson-form') form.querySelector('input[name="horario"]').value = horario

  const dateInput = form.querySelector('input[name="data"]') || form.querySelector('input[name="dataOriginal"]');
  dateInput.value = date ? date : hojeISO(); // Use a data da aula se fornecida, ou a data de hoje
}

// -- Today Functions --

const spreadPast = 0
const spreadFuture = 14

const diasMap = { "Domingo": 0, "Segunda": 1, "Terça": 2, "Quarta": 3, "Quinta": 4, "Sexta": 5, "Sábado": 6 }
const diasSemanaNomes = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];

function nextLessons(alunos) {
  const hoje = new Date();
  const fim = new Date();
  fim.setDate(hoje.getDate() + spreadFuture);
  hoje.setDate(hoje.getDate() - spreadPast);

  const hojeStr = hoje.toISOString().split("T")[0];
  const amanha = new Date(hoje);
  amanha.setDate(hoje.getDate() + 1);
  const amanhaStr = amanha.toISOString().split("T")[0];

  const aulasHoje = [];
  const aulasOutras = [];

  // Loop de cada dia do intervalo
  for (let d = new Date(hoje); d <= fim; d.setDate(d.getDate() + 1)) {
    const diaSemanaNum = d.getDay();
    const diaSemanaNome = diasSemanaNomes[diaSemanaNum];
    const dataStr = d.toISOString().split("T")[0]; // formato YYYY-MM-DD

    // Determina o rótulo da data para exibição
    let labelData;
    if (dataStr === hojeStr) labelData = `Hoje (${diaSemanaNome})`;
    else if (dataStr === amanhaStr) labelData = `Amanhã (${diaSemanaNome})`;
    else labelData = `${dataStr} (${diaSemanaNome})`

    // Para cada aluno, verifica se tem aula neste dia
    alunos.forEach(aluno => {
      if (aluno.pausado) return;
      if (aluno.inicioContrato && new Date(aluno.inicioContrato) > d) return;
      if (aluno.fimContrato && new Date(aluno.fimContrato) < d) return;

      for (let i=1; i<=3; i++) {
        if (diasMap[aluno[`diaSemana${i}`]] === diaSemanaNum) {
          const aula = {
            eventId: 'ev_' + uuidv4(),
            alunoId: aluno.id,
            nome: aluno.nome,
            telefone: aluno.telefone,
            data: labelData,      // formato amigável para exibição
            dataISO: dataStr,     // formato YYYY-MM-DD para uso no código
            horario: aluno[`horario${i}`],
            endereco: aluno.endereco
          }
          if (dataStr === hojeStr) aulasHoje.push(aula)
          else aulasOutras.push(aula)
        }
      }
    });
  }

  // Ordena por dataISO e horário
  aulasDadas.sort((a, b) => {
    const aDate = new Date(`${a.dataISO}T${a.horario}`);
    const bDate = new Date(`${b.dataISO}T${b.horario}`);
    return aDate - bDate;
  });

  return [aplicarAjustesAgenda(aulasHoje), aplicarAjustesAgenda(aulasOutras)];
}

function aplicarAjustesAgenda(aulasAgendadas) {
  return aulasAgendadas
    .filter(ag => !aulasDadas.some(ad => ad.aluno === ag.alunoId && ad.data === ag.dataISO && ad.horario == ag.horario)) // remove aulas dadas
    .map(ag => { // aplica reagendamentos
      const evento = reagendadas.find(r => r.idAluno === ag.id && r.dataOriginal === ag.dataISO && r.horarioOriginal === ag.horario);

      if (evento) {
        //if (evento.cancelled) return null; // completly remove cancelled classes (won't be displayed)
        return {
          ...ag,
          data: evento.novaDataLabel,
          dataISO: evento.novaData,
          horario: evento.novoHorario,
          cancelled: evento.cancelled
        };
      }

      return ag;
    })
    .filter(Boolean); // removes all nulls (i.e. cancelled aulas)
}

function reagendar(cancel = false) {
  if (cancel && !confirm('Tem certeza que deseja cancelar esta aula?')) return;

  const form = document.getElementById('event-form');
  const formData = new FormData(form);
  const fomData = Object.fromEntries(formData.entries());

  // Fallbacks if not filled
  if (!fomData.novaData) fomData.novaData = fomData.dataOriginal;
  if (!fomData.novoHorario) fomData.novoHorario = fomData.horarioOriginal;
  fomData.cancelled = cancel;

  // Check if this event already exists in reagendadas
  const existing = reagendadas.find(r => 
    r.id === fomData.id &&
    (r.novaData === fomData.dataOriginal && r.novoHorario === fomData.horarioOriginal)
  );

  if (existing) { // Keep the very first originals
    fomData.dataOriginal = existing.dataOriginal;
    fomData.horarioOriginal = existing.horarioOriginal;
  }

  // Replace or insert, using original values as the unique key
  const index = reagendadas.findIndex(r =>
    r.id === fomData.id &&
    r.dataOriginal === fomData.dataOriginal &&
    r.horarioOriginal === fomData.horarioOriginal
  );

  if (index !== -1) reagendadas[index] = fomData; // replace
  else reagendadas.push(fomData); // insert

  // remove past date from reagendadas
  const stripTime = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  reagendadas = reagendadas.filter(reg => stripTime(new Date(reg.novaData)) >= stripTime(new Date()))

  saveData();
  form.reset();
  showPage('agenda');
}

function renderAgenda() {
  const proximasAulas = nextLessons(alunos);
  const agenda = [document.getElementById('today'), document.getElementById('nextDays')]
  agenda[0].innerHTML = '';
  agenda[1].innerHTML = '';

  for(let i=0;i<proximasAulas.length;i++){
    if (proximasAulas[i].length === 0) {
      agenda[i].classList.remove('grid');
      agenda[i].innerHTML = `<p class="tac">Nenhuma aula agendada para ${i?'os próximos dias':'hoje'} :)</p>`;
      continue;
    }
    agenda[i].classList.add('grid');

    const frag = document.createDocumentFragment();
    
    proximasAulas[i].forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      if(item.cancelled) card.classList.add('partiallyVisible')

      if(item.cancelled || i) addbtn = `<div class="btn" onClick="showPage('edit-event', '${item.alunoId}', '${item.dataISO}', '${item.horario}')">Editar</div>`
      else addbtn = `<div class="btn" onClick="showPage('add-lesson', '${item.alunoId}', '${item.dataISO}', '${item.horario}')">Adicionar</div>`

      const dow = new Intl.DateTimeFormat('pt-BR',{ weekday:'short' }).format(new Date(item.dataISO+'T00:00:00')) //day of the week

      card.innerHTML = `
        <div class="nome">${item.nome}</div>
        <div class="linha">${rotuloData(item.dataISO)}  •  ${dow.charAt(0).toUpperCase()+dow.slice(1,3)}  •  ${horaBR(item.horario)}${item.cancelled ? ' (cancelada)' : ''}</div>
        <div class="rodape">
          ${addbtn}
          <a class="btn noround" href="https://google.com/maps/dir/?api=1&destination=${item.endereco.replace(/ ,/g, "+")}" target="_blank" rel="noopener noreferrer">Maps</a>
          <a class="btn" href="https://wa.me/${item.telefone.replace(/[ +\-\(\)'"]/g, "")}" target="_blank" rel="noopener noreferrer">Whatsapp</a>
        </div>
      `;
      frag.appendChild(card);
    });

    agenda[i].replaceChildren(frag);
  }
}

// -- Panorama Functions -- 

function renderPanorama(){
  const panorama = filterPanorama()

  const tbody = document.querySelector('#lessons-summary tbody');
  tbody.innerHTML = '';

  panorama
    .sort((a, b) => a.nome.localeCompare(b.nome))
    .forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry?.nome || ''}</td>
        <td>${entry?.aulasRealizadas || '0'}</td>
        <td>${entry?.aulasPagas.toString().replace(".",",") || '0'}</td>
      `;
      tbody.appendChild(tr);
    })
}

function filterPanorama(){
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const monthStart = new Date(year, month, 1);
  const monthEnd = new Date(year, month + 1, 0);

  const startPanorama = document.getElementById('startPanorama')
  const endPanorama = document.getElementById('endPanorama')
  startPanorama.value = startPanorama.value ? startPanorama.value : dateConvert(monthStart)
  endPanorama.value = endPanorama.value ? endPanorama.value : dateConvert(monthEnd)

  return calcPanorama(startPanorama.value, endPanorama.value)
}


function calcPanorama(start, end) {
  const inicio = new Date(start)
  const fim = new Date(end)

  return resultado = alunos.map(aluno => {
    // Pagamentos até o fim do período → saldo inicial
    let saldo = (aluno.pagamentos || [])
      .filter(p => new Date(p.data) <= fim)
      .reduce((sum, p) => sum + p.valor, 0);

    // Aulas antes do período → desconta custo
    const aulasAnteriores = aulasDadas.filter(a =>
      a.aluno === aluno.id &&
      new Date(a.data) < inicio
    );
    for (const aula of aulasAnteriores) {
      saldo -= aula.tempo * aula.valorHora;
    }

    // Aulas no período (ordenadas por data)
    const aulasPeriodo = aulasDadas
      .filter(a =>
        a.aluno === aluno.id &&
        new Date(a.data) >= inicio &&
        new Date(a.data) <= fim
      )
      .sort((a, b) => new Date(a.data) - new Date(b.data));

    // Contagem com frações
    let aulasPagas = 0;
    for (const aula of aulasPeriodo) {
      const custoAula = aula.tempo * aula.valorHora;
      if (saldo >= custoAula) {
        aulasPagas += 1; // aula inteira
        saldo -= custoAula;
      } else if (saldo > 0) {
        aulasPagas += saldo / custoAula; // fração
        saldo = 0;
      }
    }

    return {
      nome: aluno.nome,
      aulasRealizadas: aulasPeriodo.length,
      aulasPagas: parseFloat(aulasPagas.toFixed(2)) // até 2 casas decimais
    };
  });
}

// -- FAB functions --

const toggleFab = () => {
  document.getElementById('floatButton').classList.toggle('fab-open');
  const options = document.querySelectorAll('.fab-option');
  options.forEach(opt => opt.classList.toggle('fab-visible'));
  document.getElementById('overlay').classList.toggle('visible');
  const today = new Date()
  document.documentElement.style.setProperty('--today-day', `"${today.getDate()}"`)
}

const actionFab = (str) => {
  if (str) showPage(str)
  toggleFab();
}

const hideOverlay = () => toggleFab();

// -- Date and Time Functions --

const dateConvert = (date) => {
  const today = date ? date : new Date();
  const year = today.getFullYear();
  const month = (today.getMonth() + 1).toString().padStart(2, '0');
  const day = today.getDate().toString().padStart(2, '0');
  return `${year}-${month}-${day}`;
};

let endDate = new Date();
let startDate = new Date(endDate); // copy
startDate.setMonth(startDate.getMonth() - 1);

const minReport = (date) => {
  startDate = new Date(date);
  generateReport();
}

const maxReport = (date) => {
  endDate = new Date(date);
  generateReport();
}

const invertDate = (date) => {
  if (!date) return '';
  const [year, month, day] = date.split('-');
  return `${day}/${month}/${year}`;
}

function hojeISO(){ 
  const d = new Date();
  return d.toISOString().slice(0,10);
}

function addDaysISO(n){
  const d = new Date();
  d.setDate(d.getDate()+n);
  return d.toISOString().slice(0,10);
}

function rotuloData(iso){
  const today = hojeISO();
  const tomorrow = addDaysISO(1);
  if(iso === today) return "Hoje";
  if(iso === tomorrow) return "Amanhã";

  const dt = new Date(iso+"T00:00:00");
  const fmt = new Intl.DateTimeFormat('pt-BR',{ day:'2-digit', month:'short' });

  return fmt.format(dt).replace('.', '').toLowerCase();
}

function horaBR(hhmm){
  const [h,m] = hhmm.split(':');
  return `${h}h${m>0?m:''}`
}

document.getElementById('startFilter').value = dateConvert(startDate);
document.getElementById('endFilter').value = dateConvert(endDate);

// -- Student Functions --

document.getElementById('student-form').addEventListener('submit', e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  if (data.id) {
    const idx = alunos.findIndex(a => a.id == data.id);
    alunos[idx] = { ...alunos[idx], ...data };
  } else {
    data.id = 'st_' + uuidv4();
    data.pausado = false;
    data.pagos = 0;
    alunos.push(data);
  }
  saveData();
  e.target.reset();
  showPage('list-students');
});

const filterStudents = (searchString) => alunos.filter(a => a.nome.toLowerCase().includes(searchString.toLowerCase()));

function renderStudents(searchString = null) {
  const filteredStudents = searchString ? filterStudents(searchString) : alunos;
  const listStudents = document.getElementById('students-grid');
  listStudents.innerHTML = '';

  listStudents.classList.add('grid');
  if (filteredStudents.length === 0) {
    listStudents.classList.remove('grid');
    listStudents.innerHTML = `<p>Nenhum resultado encontrado ${searchString ? `para <b>${searchString}</b> ` : ''}=/</p>`;
    return;
  }

  const frag = document.createDocumentFragment();
  filteredStudents.forEach(student => {
    const valorDevido = aulasDadas
      .filter(au => au.aluno == student.id && !au.experimental)
      .reduce((soma, au) => soma + (au.tempo * au.valorHora), 0);
    const saldo = student.pagos - valorDevido;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="nome">${student.nome}<div class="ampel" style="color:${student.pausado ? 'red' : '#49e048'};"></div></div>
      <div class="linha">${student.diaSemana1 && student.horario1 ? `${student.diaSemana1.slice(0,3) || ''} ${horaBR(student.horario1) || ''}` : ''}${student.diaSemana2 && student.horario2 ? `  •  ${student.diaSemana2.slice(0,3) || ''} ${horaBR(student.horario2) || ''}` : ''}${student.diaSemana3 && student.horario3 ? `  •  ${student.diaSemana3.slice(0,3) || ''} ${horaBR(student.horario3) || ''}` : ''}</div>
      <div class="linha">Saldo:<span style="color:${saldo < 0 ? 'var(--money-red)' : 'var(--money-green)'}; font-weight:bold">R$ ${saldo.toFixed(2).replace(".",",")}</span></div>
      <div class="rodape">
        <div class="btn" onClick="openStudent('${student.id}')">Info</div>
        <div class="btn" onClick="generateThisReport('${student.id}')">Relatório</div>
      </div>
    `;

    frag.appendChild(card);
  });
  listStudents.replaceChildren(frag);
}

function openStudent(id) {
  alunoSelecionado = alunos.find(a => a.id == id);
  const valorDevido = aulasDadas
    .filter(au => au.aluno == id && !au.experimental)
    .reduce((soma, au) => soma + (au.tempo * au.valorHora), 0);

  document.getElementById('student-info').innerHTML = `
    <p><b>Nome:</b> ${alunoSelecionado.nome || ''}</p>
    <p><b>Status:</b> <span style="color:${alunoSelecionado.pausado ? 'var(--money-red)' : 'var(--money-green)'}">${alunoSelecionado.pausado ? 'Pausado' : 'Ativo'}</span></p>
    <p><b>Horários:</b>
      ${alunoSelecionado.diaSemana1 && alunoSelecionado.horario1 ? `${alunoSelecionado.diaSemana1.slice(0,3) || ''} ${horaBR(alunoSelecionado.horario1) || ''}` : ''}
      ${alunoSelecionado.diaSemana2 && alunoSelecionado.horario2 ? `  •  ${alunoSelecionado.diaSemana2.slice(0,3) || ''} ${horaBR(alunoSelecionado.horario2) || ''}` : ''}
      ${alunoSelecionado.diaSemana3 && alunoSelecionado.horario3 ? `  •  ${alunoSelecionado.diaSemana3.slice(0,3) || ''} ${horaBR(alunoSelecionado.horario3) || ''}` : ''}
    </p>
    <hr>
    <p><b>Responsável:</b> ${alunoSelecionado.responsavel || ''}</p>
    <p><b>Telefone:</b> <a href="https://wa.me/${alunoSelecionado.telefone.replace(/[ +\-\(\)'"]/g, "")}" target="_blank" rel="noopener noreferrer">${alunoSelecionado.telefone || ''}</a></p>
    ${alunoSelecionado.responsavel2 ? 
      `<p><b>Responsável 2:</b> ${alunoSelecionado.responsavel2 || ''}</p>` : ''}
    ${alunoSelecionado.telefone2 ? 
      `<p><b>Telefone 2:</b> <a href="https://wa.me/${alunoSelecionado.telefone2.replace(/[ +\-\(\)'"]/g, "")}" target="_blank" rel="noopener noreferrer">${alunoSelecionado.telefone2 || ''}</a></p>` : ''}
    <p><b>Endereço:</b> ${alunoSelecionado.endereco || ''}</p>
    <hr>
    <p><b>Escola:</b> ${alunoSelecionado.escola ||  ''}</p>
    <p><b>Série:</b> ${alunoSelecionado.serie || ''}</p>
    <hr>
    <p><b>Valor hora:</b> R$ ${alunoSelecionado.valorHora}</p>
    <p><b>Horas totais:</b> ${(aulasDadas.filter(au => au.aluno == id).reduce((soma, au) => soma + au.tempo, 0)).toString().replace(".",",")} horas</p>
    <p><b>Valor Devido:</b> R$ ${valorDevido.toFixed(2).replace(".",",")}</p>
    <p><b>Valor Pago:</b> R$ ${alunoSelecionado.pagos.toFixed(2).replace(".",",")}</p>
    <p><b>Saldo:</b> <span style="color:${(alunoSelecionado.pagos - valorDevido) < 0 ? 'var(--money-red)' : 'var(--money-green)'}; font-weight:bold;">R$ ${(alunoSelecionado.pagos - valorDevido).toFixed(2).replace(".",",")}</span></p>
    <hr>
    <p><b>Início:</b> ${invertDate(alunoSelecionado.inicioContrato) || ''}</p>
    <p><b>Fim:</b> ${invertDate(alunoSelecionado.fimContrato) || ''}</p>
    <hr>
    <p><b>Observações:</b> ${alunoSelecionado.observacoes || ''}</p>
    <hr>
    <div class="flexContainer">
      <button onclick="pauseThatStudent()">${alunoSelecionado.pausado ? 'Reativar' : 'Pausar'} Aluno</button>
      <button onclick="editStudent()">Editar</button>
    </div>
    <hr>
    <div class="flexContainer">
      <button onclick="changeHourly()">Alterar valor hora</button>
      <button onclick="showPage('add-payment', alunoSelecionado.id)">Pagamento</button>
      <button onclick="generateReport()">Relatório</button>
    </div>
  `;

  document.getElementById('student-history').innerHTML = studentStatement();
  showPage('student-details');
}

function pauseStudent() {
  if (!alunoSelecionado) return;
  alunoSelecionado.pausado = !alunoSelecionado.pausado;
  saveData();
}

function pauseThisStudent(id) {
  alunoSelecionado = alunos.find(a => a.id == id);
  pauseStudent();
  showPage('list-students');
}

function pauseThatStudent() {
  pauseStudent();
  openStudent(alunoSelecionado.id);
}

function editStudent() {
  showPage('add-student');
  const form = document.getElementById('student-form');
  for (let k in alunoSelecionado) {
    if (form[k] !== undefined) form[k].value = alunoSelecionado[k];
  }
}

function editThisStudent(id) {
  alunoSelecionado = alunos.find(a => a.id == id);
  editStudent()
}

function changeHourly() {
  const val = prompt('Qual o novo valor da hora aula?');
  if (isNaN(val)) return;
  alunoSelecionado.valorHora = val;
  saveData();
  openStudent(alunoSelecionado.id);
}

// -- Lesson Functions --

document.getElementById('lesson-form').addEventListener('submit', e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());

  // Garantir booleano para experimental
  data.experimental = formData.has('experimental');

  if (data.id) {
    const idx = aulasDadas.findIndex(l => l.id == data.id);
    aulasDadas[idx] = { 
      ...aulasDadas[idx], 
      ...data, 
      tempo: parseFloat(data.tempo), 
      valorHora: parseFloat(aulasDadas[idx].valorHora) 
    };
  } else {
    data.id = 'cl_' + uuidv4();
    const aluno = alunos.find(a => a.id == data.aluno);
    data.valorHora = parseFloat(aluno.valorHora);
    data.tempo = parseFloat(data.tempo);
    aulasDadas.push(data);
  }

  saveData();
  e.target.reset();
  showPage('agenda');
});

function renderLessons() {
  const tbody = document.querySelector('#lessons-table tbody');
  const filtro = document.getElementById('filter-student').value;
  tbody.innerHTML = '';
  aulasDadas
    .filter(l => !filtro || l.aluno == filtro)
    .sort((a, b) => new Date(b.data) - new Date(a.data))
    .forEach(l => {
    const aluno = alunos.find(a => a.id == l.aluno);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${aluno?.nome || ''}</td>
      <td>${invertDate(l.data).toString().slice(0,5)}</td>
      <td>${l.tempo.toString().replace(".",",")}</td>
      <td class="mob">R$ ${l.experimental ? '0,00' : l.valorHora.toFixed(2).replace(".",",")}</td>
      <td class="flexContainer">
        <div class="button" onclick="editLesson('${l.id}')">${iconEdit}</div>
        <div class="button" onclick="deleteLesson('${l.id}')">${iconDelete}</div>
      </td>`;
    tbody.appendChild(tr);
  });
}

function toggleExp(id) {
  const aula = aulasDadas.find(a => a.id == id);
  aula.experimental = !aula.experimental;
  saveData();
  renderLessons();
}

function editLesson(id) {
  showPage('add-lesson');
  const aula = aulasDadas.find(a => a.id == id);
  const form = document.getElementById('lesson-form');

  for (let k in aula) {
    if (form[k] !== undefined && k !== 'experimental') {
      form[k].value = aula[k];
    }
  }
  form.experimental.checked = !!aula.experimental; // Marcar checkbox conforme valor
}


const deleteLesson = (id) => {
  aulasDadas = aulasDadas.filter(a => a.id !== id);
  saveData();
  renderLessons();
}

// -- Payment Functions --

document.getElementById('payment-form').addEventListener('submit', e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const alunoId = formData.get('aluno');
  const valor = parseFloat(formData.get('valor'));
  const data = formData.get('data');

  if (isNaN(valor) || !data) {
    alert('Preencha todos os campos corretamente.');
    return;
  }

  const aluno = alunos.find(a => a.id === alunoId);
  if (!aluno) {
    alert('Aluno não encontrado.');
    return;
  }

  aluno.pagamentos = aluno.pagamentos || [];
  aluno.pagamentos.push({ data, valor });
  aluno.pagos = (aluno.pagos || 0) + valor;

  saveData();
  e.target.reset();
  showPage('panorama');
});


// -- Report Functions --

function generateThisReport(id) {
  alunoSelecionado = alunos.find(a => a.id == id);
  generateReport()
}

const listCompletedLessons = () => {
  if (!alunoSelecionado) return []
  return aulasDadas
    .filter(a => a.aluno === alunoSelecionado.id)
    .map(a => ({
      tipo: 'aula',
      data: a.data,
      tempo: a.tempo,
      valor: a.experimental ? 0 : (-a.tempo * a.valorHora), // valor devido
      experimental: a.experimental || false
    }));
}

const listPayments = () => {
  if (!alunoSelecionado || !alunoSelecionado.pagamentos) return []
  pagamentosAluno = (alunoSelecionado.pagamentos || []).map(pagamento => ({
      tipo: "pagamento",
      data: pagamento.data,
      valor: pagamento.valor || 0 // Pagamento gera crédito
  }));
  return pagamentosAluno;
}

function studentStatement() {
  if (!alunoSelecionado) return '';
  
  const aulas = listCompletedLessons();
  const pagamentos = listPayments();

  // Juntar tudo e ordenar por data
  const historico = [...pagamentos, ...aulas].sort((a, b) => new Date(a.data) - new Date(b.data));
  
  // Gerar texto do relatório
  let saldo = 0;
  let previousDate = null;
  let table = '';
  
  historico.forEach(item => {
    if (item.data !== previousDate) {
      table = previousDate ? `
        <tr class="table-balance">
          <td><b>${invertDate(previousDate)}</b></td>
          <td>Saldo: <span style="color:${saldo<0 ? 'var(--money-red)' : 'var(--money-green)'}">R$ ${saldo.toFixed(2).replace('.', ',')}</span></td>
        </tr>
      ` + table : table;
      previousDate = item.data;
    }
    saldo += item.valor;

    table = `
    <tr>
      <td>${item.tipo === "pagamento" ? 'Pagamento' : `Aula ${item.experimental ? 'experimental' : `(${item.tempo} hora${item.tempo > 1 ? 's' : ''})`}`}</td>
      <td> R$ ${item.experimental ? '0,00' : Math.abs(item.valor).toFixed(2).replace('.', ',')}</td>
    </tr>
    ` + table;;

  });

  table = `
  <table id="statement">
    <thead>
      <tr class="table-balance">
        <th>Item</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody>
      <tr class="table-balance">
        <td><b>${invertDate(previousDate)}</b></td>
        <td>Saldo: <span style="color:${saldo<0 ? 'var(--money-red)' : 'var(--money-green)'}">R$ ${saldo.toFixed(2).replace('.', ',')}</span></td>
      </tr>
      ` + table + `
    </tbody>
  </table>`;

  return table
}

function generateReport() {
  if (!alunoSelecionado) {
      alert("Nenhum aluno selecionado.");
      return;
  }

  const aulas = listCompletedLessons();
  const pagamentos = listPayments();

  const filteredAulas = aulas.filter(a => new Date(a.data) >= startDate && new Date(a.data) <= endDate).sort((a, b) => new Date(a.data) - new Date(b.data));
  const filteredPagamentos = pagamentos.filter(a => new Date(a.data) >= startDate && new Date(a.data) <= endDate).sort((a, b) => new Date(a.data) - new Date(b.data));

  // Gerar texto do relatório
  let saldo = 0;
  let relatorio = '<b>Aulas:</b><br>';
  let count = 0;

  filteredAulas.forEach(item => {
      if (!item.experimental) count++;
      saldo += item.valor;
      relatorio += `${invertDate(item.data)} (${item.experimental ? "experimental" : (count + 'ª aula')}) - ${item.tempo} hora${item.tempo > 1 ? 's' : ''} - R$ ${item.experimental ? '0,00' : Math.abs(item.valor).toFixed(2).replace('.', ',')}<br>`;
  });

  relatorio += `<br><b>Pagamentos:</b><br>`;
  filteredPagamentos.forEach(item => {
      saldo += item.valor;
      relatorio += `${invertDate(item.data)} - R$ ${Math.abs(item.valor).toFixed(2)}<br>`;
  });

  relatorio += `<br><b>Saldo total</b>: R$ ${Math.abs(saldo.toFixed(2))} (${saldo >= 0 ? "crédito" : "débito"})`;

  document.getElementById('report-content').innerHTML = relatorio;
  showPage('report');
}

const copyToClipboard = () => {
  const reportContent = document.getElementById('report-content').innerHTML
    .replace(/<\/?b>/gi, "*") // Replace <b> tags with asterisks
    .replace(/<br\s*\/?>/gi, "\n") // Replace <br> and <br/> with newline
    .replace(/<[^>]+>/g, ""); // Remove any other HTML tags just in case
  navigator.clipboard.writeText(reportContent).then(() => {
    alert('Relatório copiado para a área de transferência!');
  }).catch(err => {
    console.error('Erro ao copiar:', err);
    alert('Erro ao copiar o relatório.');
  });
}

// -- Data Functions --

function saveData() {
  localStorage.setItem('alunos', JSON.stringify(alunos));
  localStorage.setItem('aulasDadas', JSON.stringify(aulasDadas));
  localStorage.setItem('reagendadas', JSON.stringify(reagendadas)); // Aulas reagendadas: {idAluno, dataOriginal, novaData, novoHorario}
  // localStorage.setItem('aulasDadas', JSON.stringify(dadas)); // Aulas concluídas: {idAluno, data}
}

function eraseData() {
  if (confirm('Tem certeza que deseja apagar todos os dados?')) {
    localStorage.removeItem('alunos');
    localStorage.removeItem('aulasDadas');
    localStorage.removeItem('reagendadas');

    alunos = [];
    aulasDadas = [];
    reagendadas = [];

    showPage('list-students');
    document.getElementById('tab1').checked = true;
    alert('Dados apagados!');
  }
}

function exportData() {
  const data = JSON.stringify({ alunos, aulasDadas, reagendadas }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'backup.json';
  a.click();
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const data = JSON.parse(reader.result);
    alunos = data.alunos || [];
    aulasDadas = data.aulasDadas || [];
    saveData();
    alert('Backup importado!');
    showPage('agenda');
    document.getElementById('tab1').checked = true;
  };
  reader.readAsText(file);
}

const uuidv4 = () => "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c => (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16));

// -- Service Worker Registration --

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker registrado com sucesso:', registration.scope);
      })
      .catch(error => {
        console.log('Falha no registro do Service Worker:', error);
      });
  });
}

// -- Initialization --

let alunos = JSON.parse(localStorage.getItem('alunos') || '[]');
let aulasDadas = JSON.parse(localStorage.getItem('aulasDadas') || '[]');
let reagendadas = JSON.parse(localStorage.getItem('reagendadas') || '[]');
let alunoSelecionado = null;

showPage('agenda');